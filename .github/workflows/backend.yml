name: Spring Boot CI/CD

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'back-end/mind_stack_id/**'
      - '.github/workflows/backend.yml'
  pull_request:
    branches: [ "main", "develop" ]
    paths:
      - 'back-end/mind_stack_id/**'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build with Maven
      working-directory: ./back-end/mind_stack_id
      run: mvn clean install -DskipTests

    - name: Run tests
      working-directory: ./back-end/mind_stack_id
      run: mvn test

    - name: Build JAR file
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      working-directory: ./back-end/mind_stack_id
      run: mvn package -DskipTests

    - name: Upload JAR artifact
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: spring-boot-jar
        path: back-end/mind_stack_id/target/*.jar
        retention-days: 1

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: spring-boot-jar
        path: ./artifact

    - name: Deploy JAR to Hostinger VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        source: "artifact/*.jar"
        target: "/home/${{ secrets.VPS_USERNAME }}/mind-stack-backend"
        strip_components: 1

    - name: Execute deployment on VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          cd /home/${{ secrets.VPS_USERNAME }}/mind-stack-backend
          
          echo "Stopping application..."
          sudo systemctl stop mind-stack-backend || true
          
          if [ -f application.jar ]; then
            echo "Backing up old JAR..."
            mv application.jar application.jar.backup.$(date +%Y%m%d_%H%M%S)
            ls -t application.jar.backup.* | tail -n +4 | xargs rm -f 2>/dev/null || true
          fi
          
          echo "Deploying new JAR..."
          mv *.jar application.jar
          
          echo "Starting application..."
          sudo systemctl start mind-stack-backend
          
          echo "Waiting for application to start..."
          sleep 10
          
          if sudo systemctl is-active --quiet mind-stack-backend; then
            echo "✅ Application started successfully"
            
            if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "✅ Health check passed"
            else
              echo "⚠️  Health check failed, but service is running"
            fi
          else
            echo "❌ Application failed to start"
            echo "Rolling back to previous version..."
            
            if ls application.jar.backup.* 1> /dev/null 2>&1; then
              latest_backup=$(ls -t application.jar.backup.* | head -n 1)
              mv "$latest_backup" application.jar
              sudo systemctl start mind-stack-backend
              echo "Rolled back to previous version"
            fi
            
            exit 1
          fi
