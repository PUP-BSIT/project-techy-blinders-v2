<div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
    
    <div class="scrollable-content">
        <div class="post-section">
        <div class="user-header">
            <div class="user-avatar" (click)="goToUserProfile(post.user_id, $event)">{{ getInitial(post.username) }}</div>
            <div class="user-info">
            <span class="username" (click)="goToUserProfile(post.user_id, $event)">{{ post.username }}</span>
            <span class="timestamp">Posted {{ getTimeAgo(post.created_at) }}</span>
            </div>
        </div>

        <div class="post-card-modal">
            <div class="post-header-modal">
            <span class="post-label">Caption:</span>
            <span class="post-category">{{ post.title }}</span>
            @if (isPostOwner()) {
            <button class="menu-btn" (click)="togglePostMenu($event)">
                <svg width="4" height="16" viewBox="0 0 4 16" fill="currentColor">
                <circle cx="2" cy="2" r="2"/>
                <circle cx="2" cy="8" r="2"/>
                <circle cx="2" cy="14" r="2"/>
                </svg>
            </button>
            @if (showPostMenu) {
                <div class="dropdown-menu">
                <button class="dropdown-item" (click)="onEditPost($event)">
                    <svg width="14" height="14" 
                         viewBox="0 0 14 14" 
                         fill="none" 
                         stroke="currentColor">
                    <path d="M10 1.5L12.5 4L4.5 12H2V9.5L10 1.5Z" 
                          stroke-width="1.5" 
                          stroke-linecap="round" 
                          stroke-linejoin="round"/>
                    </svg>
                    Edit
                </button>
                <button class="dropdown-item delete" (click)="onDeletePost($event)">
                    <svg width="14" 
                         height="14" 
                         viewBox="0 0 14 14" 
                         fill="none" 
                         stroke="currentColor">
                    <path d="M1.5 3.5H12.5M11 3.5V12C11 12.5 10.5 13 10 13H4C3.5 13 3 12.5 3 12V3.5M4.5 3.5V2C4.5 1.5 5 1 5.5 1H8.5C9 1 9.5 1.5 9.5 2V3.5" 
                          stroke-width="1.5" 
                          stroke-linecap="round" 
                          stroke-linejoin="round"/>
                    </svg>
                    Unpublish
                </button>
                        @if (showDeleteConfirmForPost) {
                            <div class="confirm-overlay" 
                                 (click)="cancelDeletePost($event)">
                                <div class="confirm-modal" 
                                     (click)="$event.stopPropagation()">
                                    <div class="confirm-title">
                                        Unpublish this post?
                                    </div>
                                    <div class="confirm-subtext">
                                        This will remove it from Community 
                                        and set the linked to Private. 
                                        You can republish later.
                                    </div>
                                    <div class="confirm-actions">
                                        <button class="btn-cancel" 
                                        (click)="cancelDeletePost($event)">
                                            Cancel
                                        </button>
                                        <button class="btn-danger" 
                                        (click)="confirmDeletePost($event)">
                                            Unpublish
                                    </button>
                                    </div>
                                </div>
                            </div>
                        }
                </div>
            }
            }
            </div>

            <div class="post-category-section">
            <span class="category-label">Category:</span>
            <span class="category-value">{{ post.category }}</span>
            </div>

            <div class="post-content-card">
            <button class="play-btn">
                ▶
            </button>
            <div class="post-info">
                <h3 class="post-title">{{ getOriginalTitle() }}</h3>
                <p class="post-subtitle">{{ getSubtitle() }}</p>
            </div>
            </div>

            <div class="action-buttons">
            <button class="action-btn" 
                    [class.active]="post.userLiked" 
                    (click)="onLike()">
                <img src="assets/arrow-up.png" alt="like" class="action-icon">
                <span>{{ post.likes }}</span>
            </button>
            <button class="action-btn" 
                    [class.active]="post.userDisliked" 
                    (click)="onDislike()">
                <img src="assets/arrow-down.png" 
                     alt="dislike" 
                     class="action-icon">
                <span>{{ post.dislikes }}</span>
            </button>
            <button class="action-btn">
                <img src="assets/comment-circle.png" 
                     alt="comment" 
                     class="action-icon">
                <span>{{ post.commentcount }}</span>
            </button>
            </div>
        </div>
        </div>

        <div class="comments-section">
        @for (comment of comments; track comment.comment_id) {
        <div class="comment-thread">
            <div class="comment-item" [attr.data-comment-id]="comment.comment_id">
            <div class="comment-header">
                <div class="user-avatar-small" (click)="goToUserProfile(comment.user_id, $event)">
                    {{ getInitial(comment.username) }}
                </div>
                <div class="comment-info">
                <span class="username" (click)="goToUserProfile(comment.user_id, $event)">{{ comment.username }}</span>
                <span class="timestamp">
                     · {{ getTimeAgo(comment.created_at) }}
                </span>
                </div>
                @if (isCommentOwner(comment)) {
                <button class="comment-menu-btn" 
                        (click)="toggleCommentMenu($event, comment.comment_id)">
                    <svg width="4" height="16" viewBox="0 0 4 16" fill="currentColor">
                    <circle cx="2" cy="2" r="2"/>
                    <circle cx="2" cy="8" r="2"/>
                    <circle cx="2" cy="14" r="2"/>
                    </svg>
                </button>
                @if (showMenuForComment === comment.comment_id) {
                    <div class="comment-dropdown-menu">
                    <button class="dropdown-item" 
                            (click)="onEditComment($event, comment)">
                        <svg width="14" height="14" 
                             viewBox="0 0 14 14" 
                             fill="none" 
                             stroke="currentColor">
                        <path d="M10 1.5L12.5 4L4.5 12H2V9.5L10 1.5Z" 
                              stroke-width="1.5" 
                              stroke-linecap="round" 
                              stroke-linejoin="round"/>
                        </svg>
                        Edit
                    </button>
                    <button class="dropdown-item delete" 
                            (click)="onDeleteComment($event, comment)">
                        <svg width="14" 
                             height="14" 
                             viewBox="0 0 14 14" 
                             fill="none" 
                             stroke="currentColor">
                        <path d="M1.5 3.5H12.5M11 3.5V12C11 12.5 10.5 13 10 13H4C3.5 13 3 12.5 3 12V3.5M4.5 3.5V2C4.5 1.5 5 1 5.5 1H8.5C9 1 9.5 1.5 9.5 2V3.5" 
                              stroke-width="1.5" 
                              stroke-linecap="round" 
                              stroke-linejoin="round"/>
                        </svg>
                        Delete
                    </button>
                    @if (showDeleteConfirmForComment === comment.comment_id) {
                        <div class="confirm-box">
                        <div class="confirm-text">Delete this comment?</div>
                        <div class="confirm-actions">
                            <button class="btn-cancel" 
                                    (click)="cancelDeleteComment($event)">Cancel
                            </button>
                            <button class="btn-delete" 
                                    (click)="confirmDeleteComment($event, comment)">Delete
                            </button>
                        </div>
                        </div>
                    }
                    </div>
                }
                }
            </div>
            @if (editingComment?.comment_id === comment.comment_id) {
                <div class="edit-comment-box">
                <textarea 
                    class="edit-comment-input"
                    [(ngModel)]="editCommentText"
                    rows="3"
                ></textarea>
                <div class="edit-comment-actions">
                    <button class="btn-cancel" (click)="onCancelEdit()">Cancel</button>
                    <button class="btn-save" (click)="onSaveEdit(comment)">Save</button>
                </div>
                </div>
            } @else {
                <p class="comment-content">{{ comment.content }}</p>
            }
            <div class="comment-actions">
                <button 
                class="action-btn-small"
                [class.active]="comment.userLiked"
                (click)="onLikeComment(comment, false)"
                >
                <img src="assets/arrow-up.png" 
                     alt="like" 
                     class="action-icon-small">
                <span>{{ comment.likes }}</span>
                </button>
                
                <button 
                class="action-btn-small"
                [class.active]="comment.userDisliked"
                (click)="onDislikeComment(comment, false)"
                >
                <img src="assets/arrow-down.png" 
                     alt="dislike" 
                     class="action-icon-small">
                <span>{{ comment.dislikes }}</span>
                </button>
                
                <button class="action-btn-small" 
                        (click)="onReply(comment, false)" 
                        title="Reply">
                <img src="assets/comment-circle.png" 
                     alt="comment" 
                     class="action-icon-small">
                <span>{{ (comment.replyCount || 0) }}</span>
                </button>
            </div>
            </div>

            @if (comment.replies && comment.replies.length > 0) {
            <div class="replies-container">
                @for (reply of comment.replies; track reply.comment_id) {
                <div class="comment-item reply" [attr.data-comment-id]="reply.comment_id">
                    <div class="comment-header">
                    <div class="user-avatar-small" (click)="goToUserProfile(reply.user_id, $event)">
                        {{ getInitial(reply.username) }}
                    </div>
                    <div class="comment-info">
                        <span class="username" (click)="goToUserProfile(reply.user_id, $event)">{{ reply.username }}</span>
                        <span class="timestamp">
                             · {{ getTimeAgo(reply.created_at) }}
                        </span>
                    </div>
                    </div>
                    <p class="comment-content">{{ reply.content }}</p>
                    <div class="comment-actions">
                    <button 
                        class="action-btn-small"
                        [class.active]="reply.userLiked"
                        (click)="onLikeComment(reply, true)"
                    >
                        <img src="assets/arrow-up.png" 
                             alt="like" 
                             class="action-icon-small">
                        <span>{{ reply.likes }}</span>
                    </button>
                    
                    <button 
                        class="action-btn-small"
                        [class.active]="reply.userDisliked"
                        (click)="onDislikeComment(reply, true)"
                    >
                        <img src="assets/arrow-down.png" 
                             alt="dislike" 
                             class="action-icon-small">
                        <span>{{ reply.dislikes }}</span>
                    </button>
                    
                    <button class="action-btn-small" 
                            (click)="onReply(reply, true)" 
                            title="Reply">
                        <img src="assets/comment-circle.png" 
                             alt="comment" 
                             class="action-icon-small">
                        <span>{{ (reply.replies?.length || 0) }}</span>
                    </button>
                    </div>
                </div>
                }
            </div>
            }
        </div>
        }

    </div>
    </div>

    <div class="add-comment">
        @if (replyingTo) {
            <div class="replying-to-indicator">
                <span>Replying to <strong>@{{ replyingTo.comment.username }}</strong></span>
                <button class="cancel-reply-btn" (click)="replyingTo = undefined; newCommentText = ''">✕</button>
            </div>
        }
        <div class="comment-input-wrapper">
            <div class="user-avatar-small">{{ currentUserInitial }}</div>
            <input 
            type="text"
            class="comment-input"
            placeholder="Add your Reply"
            [(ngModel)]="newCommentText"
            (keyup.enter)="onAddComment()"
            #replyInput
            />
            <button 
            class="send-btn"
            [disabled]="!newCommentText.trim()"
            (click)="onAddComment()"
            >
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M15 1L7 9M15 1L10 15L7 9M15 1L1 6L7 9"/>
            </svg>
            </button>
        </div>
    </div>
    </div>
</div>