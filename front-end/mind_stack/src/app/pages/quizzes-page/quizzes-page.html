<div class="container">
    <div class="content-wrapper">
        <button (click)="openModal()" 
                class="add add-desktop" 
                [disabled]="isLoading">
            <span class="add-text">+ Create New Quiz Set</span>
            <span class="add-icon">+</span>
        </button>

        @if (isLoading) {
            <div class="loading-indicator">
                Loading Quiz Sets...
            </div>
        }

        @if (!isLoading && quizzes.length === 0) {
            <div class="empty-state">
                <p class="empty-state-message">
                    No Quiz Set found. Create Now!
                </p>
            </div>
        }

        <div class="study-sets-wrapper" 
                [class.hidden]="quizzes.length === 0 || isLoading">
            <button (click)="openModal()" 
                    class="add add-mobile" 
                    [disabled]="isLoading">
                <span class="add-text">+ Create New Quiz Set</span>
                <span class="add-icon">+</span>
            </button>

            <div class="study-sets-list">
                @for (quiz of paginatedQuizzes;
                        track quiz.quiz_id;
                        let i = $index) {
                <div class="study-set-card">
                    <div class="card-left">
                        <button class="play-btn" 
                                (click)="playQuiz(quiz.quiz_id)">
                            ▶
                        </button>
                    </div>
                    <div class="study-set-info">
                        <h3 class="study-set-title">{{ quiz.title }}</h3>
                        <p class="study-set-description">
                            {{ quiz.description || 'About the Quiz' }} •
                            {{ getQuestionTypeLabel(quiz.questionType) }}
                        </p>
                        @if (getLatestAttempt(quiz.quiz_id)) {
                        <div class="latest-attempt-info">
                            <span class="attempt-label">Score:</span>
                            <span class="attempt-score">
                                {{ getLatestAttempt(quiz.quiz_id)!.totalScore }} /
                                {{ getLatestAttempt(quiz.quiz_id)!.maxScore }}
                            </span>
                            <span class="attempt-percentage">
                                (
                                    {{getLatestAttempt(quiz.quiz_id)!
                                            .percentage
                                            .toFixed(1)
                                    }}%
                                )
                            </span>
                        </div>
                        }
                        <button class="privacy-badge" 
                                (click)="openPrivacyModal(quiz.quiz_id)">
                            @if (quiz.is_public) {
                                <img src="assets/globe-icon.png" 
                                        alt="Public" 
                                        class="privacy-icon">
                            }
                            @if (!quiz.is_public) {
                                <img src="assets/lock.png" 
                                        alt="Private" 
                                        class="privacy-icon">
                            }
                            <span class="privacy-text">
                                {{ quiz.is_public ? 'Public' : 'Private' }}
                            </span>
                            <span class="dropdown-arrow">▼</span>
                        </button>
                    </div>
                    <div class="action-buttons">
                        <button class="edit-btn" 
                                (click)="editQuiz(quiz.quiz_id)">
                            Edit
                        </button>
                        <button class="delete-btn" 
                                (click)="deleteQuiz(quiz.quiz_id)">
                            Delete
                        </button>
                    </div>
                </div>
                }
            </div>

            <div class="study-sets-pagination" 
                    [class.show]="quizzesTotalPages > 1">
                <button class="pagination-btn prev" 
                            (click)="goToQuizzesPage(0)" 
                            [disabled]="quizzesCurrentPage === 0">
                    ‹‹
                </button>
                <button class="pagination-btn prev" 
                            (click)="previousQuizzesPage()" 
                            [disabled]="quizzesCurrentPage === 0">
                    ‹
                </button>
                <div class="pagination-dots">
                    @for (page of quizzesPages; track page) {
                    <span [class]="page === '...' 
                                ? 'pagination-ellipsis' 
                                : 'pagination-dot'"
                          [class.active]="isPageNumber(page) && 
                                quizzesCurrentPage === page"
                          (click)="isPageNumber(page) && 
                          goToQuizzesPage(getPageNumber(page))">
                        {{ getPageDisplay(page) }}
                    </span>
                    }
                </div>
                <button class="pagination-btn next" 
                            (click)="nextQuizzesPage()" 
                            [disabled]="quizzesCurrentPage === 
                                quizzesTotalPages - 1">
                    ›
                </button>
                <button class="pagination-btn next" 
                            (click)="goToQuizzesPage(quizzesTotalPages - 1)" 
                            [disabled]="quizzesCurrentPage === 
                                quizzesTotalPages - 1">
                    ››
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" 
            [class.open]="isModalOpen">
        <div class="modal-content quiz-modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Title</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" 
                            class="title-input" 
                            placeholder="Add Title"
                            [(ngModel)]="quizTitle"
                            maxlength="50"
                            (input)="enforceTitleLimit()"/>
                    <div class="char-indicator">
                        {{ quizTitle?.length || 0 }}/50
                    </div>
                </div>
                <div class="form-group">
                    <input type="text" 
                            class="description-input" 
                            placeholder="Description"
                            [(ngModel)]="quizDescription"
                            maxlength="100"
                            (input)="enforceDescriptionLimit()"/>
                    <div class="char-indicator">
                        {{ quizDescription?.length || 0 }}/100
                    </div>
                </div>

                <div class="form-group">
                    <select class="quiz-type-select" 
                            [(ngModel)]="selectedQuestionType"
                            (ngModelChange)="onQuestionTypeChange()">
                        <option value="" disabled selected>
                            Choose quiz type
                        </option>
                        <option [value]="QuestionType.IDENTIFICATION">
                            Identification
                        </option>
                        <option [value]="QuestionType.MULTIPLE_CHOICE">
                            Multiple Choice
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <button class="btn-ai-suggestion"
                            (click)="generateAiSuggestions()"
                            [disabled]="isLoadingSuggestion ||
                                !quizTitle.trim()">

                            @if (!isLoadingSuggestion) {
                                <span>Generate Suggestion</span>
                            }

                            @if (isLoadingSuggestion) {
                                <span>↻ Loading suggestion...</span>
                            }

                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" 
                        (click)="closeModal()" 
                        [disabled]="isLoading">
                    Cancel
                </button>
                <button class="btn-continue" 
                        (click)="saveQuiz()" 
                        [disabled]="isLoading || 
                            !quizTitle.trim() ||
                            !quizDescription.trim() || 
                            !selectedQuestionType">
                    {{ isLoading ? 'Loading...' : 'Continue' }}
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" 
            [class.open]="isQuestionModalOpen">
        <div class="modal-content question-editor-modal">
            <div class="question-modal-header">
                <div class="item-count">
                    {{ questions.length }} Items
                    <span [class.hidden]="questions.length === 1"></span>
                </div>
            </div>

            <div class="carousel-wrapper" 
                    [class.has-flashcards]="questions.length > 0">
                @if (questions.length === 0) {
                <div class="empty-state">
                    <p class="empty-message">Create your first quiz item</p>
                    <button class="add-item-btn" (click)="addQuestion()">
                        + Add Item
                    </button>
                </div>
                }
                @if (questions.length > 0) {
                <div class="flashcards-container">
                    @for (question of paginatedQuestions;
                            track $index;
                            let i = $index) {
                    <div class="flashcard-item mc-question" 
                         [class.hidden]="!isMultipleChoice()">
                        <div class="mc-question-header">
                            <div class="question-number">
                                {{ getActualIndex(i) + 1 }}
                            </div>
                            <button class="btn-delete-icon" 
                                    (click)="
                                        deleteQuestion(getActualIndex(i))">
                                ✕
                            </button>
                        </div>
                        <div class="mc-question-body">
                            <div class="question-input-section">
                                <input type="text" 
                                        class="flashcard-term" 
                                        placeholder="Question"
                                        [(ngModel)]="question.question"
                                        maxlength="150"
                                        (input)="
                                            enforceQuestionLimit(question)"/>
                                <div class="char-indicator">
                                  {{ question.question?.length || 0 }}/150
                                </div>
                                <div class="mc-options-left">
                                    <div class="mc-option-left">
                                        <div class="option-label">a.</div>
                                        <input type="text" 
                                                class="option-input-left" 
                                                placeholder=""
                                                [(ngModel)]="question.optionA"
                                                maxlength="100"
                                                (input)="enforceOptionLimit(
                                                    question,
                                                    'optionA'
                                                )"
                                        />
                                    </div>
                                    <div class="mc-option-left">
                                        <div class="option-label">b.</div>
                                        <input type="text" 
                                                class="option-input-left" 
                                                placeholder=""
                                                [(ngModel)]="question.optionB"
                                                maxlength="100"
                                                (input)="enforceOptionLimit(
                                                    question, 
                                                    'optionB'
                                                )"
                                        />
                                    </div>
                                    <div class="mc-option-left">
                                        <div class="option-label">c.</div>
                                        <input type="text" 
                                                class="option-input-left" 
                                                placeholder=""
                                                [(ngModel)]="question.optionC"
                                                maxlength="100"
                                                (input)="enforceOptionLimit(
                                                    question, 
                                                    'optionC'
                                                )"
                                        />
                                    </div>
                                    <div class="mc-option-left">
                                        <div class="option-label">d.</div>
                                        <input type="text" 
                                                class="option-input-left" 
                                                placeholder=""
                                                [(ngModel)]="question.optionD"
                                                maxlength="100"
                                                (input)="enforceOptionLimit(
                                                    question, 
                                                    'optionD'
                                                )"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div class="question-right-section">
                                <div class="select-correct-label">
                                    Select Correct Answer
                                </div>
                                <div class="mc-radios">
                                    <div class="option-radio-wrapper" 
                                            (click)="setCorrectAnswer(
                                                question, 
                                                'A'
                                            )">
                                        <div class="option-radio">
                                            <div 
                                                class="radio-dot" 
                                                [class.active]="
                                                    question.correctAnswer === 
                                                    'A'">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="option-radio-wrapper" 
                                            (click)="setCorrectAnswer(
                                                question,
                                                'B'
                                            )">
                                        <div class="option-radio">
                                            <div class="radio-dot" 
                                                    [class.active]="
                                                        question.correctAnswer ===
                                                        'B'"
                                                    >
                                            </div>
                                        </div>
                                    </div>
                                    <div class="option-radio-wrapper" 
                                            (click)="setCorrectAnswer(
                                                question,
                                                'C'
                                            )">
                                        <div class="option-radio">
                                            <div class="radio-dot" 
                                                    [class.active]="
                                                        question.correctAnswer === 
                                                        'C'">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="option-radio-wrapper" 
                                            (click)="setCorrectAnswer(
                                                    question, 
                                                    'D')">
                                        <div class="option-radio">
                                            <div class="radio-dot" 
                                                    [class.active]="
                                                        question.correctAnswer === 
                                                        'D'">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    }
                    @for (question of paginatedQuestions;
                            track $index;
                            let i = $index) {
                    <div class="flashcard-item identification-item" 
                         [class.hidden]="!isIdentification()">
                        <div class="identification-header">
                            <div class="question-number">
                                {{ getActualIndex(i) + 1 }}
                            </div>
                            <button class="btn-delete-icon" 
                                    (click)="deleteQuestion(getActualIndex(i))"
                                    >
                                ✕
                            </button>
                        </div>
                        <div class="identification-content">
                            <input type="text" 
                                    class="flashcard-term" 
                                    placeholder="Question"
                                    [(ngModel)]="question.question"
                                    maxlength="150"
                                    (input)="enforceQuestionLimit(question)"/>
                            <div class="char-indicator">
                              {{ question.question?.length || 0 }}/150
                            </div>
                            <input type="text" 
                                    class="flashcard-definition" 
                                    placeholder="Answer"
                                    [(ngModel)]="question.answer"
                                    maxlength="100"
                                    (input)="enforceAnswerLimit(question)"/>
                            <div class="char-indicator">
                              {{ question.answer?.length || 0 }}/100
                            </div>
                        </div>
                    </div>
                    }
                        <div class="add-item-section">
                            <button class="add-item-btn" 
                                    (click)="addQuestion()">
                                <span class="plus-icon">+</span> Add Item
                            </button>
                        </div>
                </div>
                }
            </div>

            <div class="study-sets-pagination" [class.show]="totalPages > 1">
                <button class="pagination-btn prev" 
                            (click)="goToPage(0)" 
                            [disabled]="currentPage === 0">
                    ‹‹
                </button>
                <button class="pagination-btn prev" 
                            (click)="previousPage()" 
                            [disabled]="currentPage === 0">
                    ‹
                </button>
                <div class="pagination-dots">
                    @for (page of questionPages; track page) {
                    <span [class]="page === '...' 
                                ? 'pagination-ellipsis' 
                                : 'pagination-dot'"
                          [class.active]="isPageNumber(page) && 
                                currentPage === page"
                          (click)="isPageNumber(page) && 
                                goToPage(getPageNumber(page))">
                        {{ getPageDisplay(page) }}
                    </span>
                    }
                </div>
                <button class="pagination-btn next" 
                            (click)="nextPage()" 
                            [disabled]="currentPage === totalPages - 1">
                    ›
                </button>
                <button class="pagination-btn next" 
                            (click)="goToPage(totalPages - 1)" 
                            [disabled]="currentPage === totalPages - 1">
                    ››
                </button>
            </div>

            <div class="question-modal-footer">
                <button class="btn-modal-cancel" 
                        (click)="confirmCancel()" 
                        [disabled]="isLoading">
                    Cancel
                </button>
                
                <button class="btn-modal-save" 
                        (click)="saveQuizFromQuestionModal()" 
                        [disabled]="isLoading">
                    {{ isLoading ? 'Saving...' : 'Save' }}
                </button>
            </div>
        </div>
    </div>

    <div class="confirm-overlay" 
            [class.open]="isDeleteModalOpen" (click)="closeDeleteModal()">
        <div class="confirm-modal" (click)="$event.stopPropagation()">
            <h3 class="confirm-title">Delete Quiz Set?</h3>
            <p class="confirm-message">
                    Do you really want to delete this study set?<br>
                    This action cannot be undone.
            </p>
            <div class="confirm-actions">
                <button class="btn-confirm-no" 
                        (click)="closeDeleteModal()">
                    Cancel
                </button>
                <button class="btn-confirm-yes" 
                        (click)="confirmDelete()">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <div class="confirm-overlay" 
            [class.open]="isNotificationModalOpen" 
            (click)="closeNotificationModal()">
        <div class="confirm-modal notification-modal" 
             [class.success]="notificationType === 'success'"
             [class.error]="notificationType === 'error'"
             [class.warning]="notificationType === 'warning'"
             (click)="$event.stopPropagation()">
            <h3 class="confirm-title">{{ notificationTitle }}</h3>
            <p class="confirm-message">{{ notificationMessage }}</p>
            <div class="confirm-actions">
                <button class="btn-confirm-yes" 
                        (click)="closeNotificationModal()">
                    OK
                </button>
            </div>
        </div>
    </div>

    <div class="privacy-settings-overlay" 
            [class.open]="isPrivacyModalOpen" (click)="closePrivacyModal()">
        <div class="privacy-settings-modal" (click)="$event.stopPropagation()">
            <h3 class="privacy-settings-title">PRIVACY SETTINGS</h3>
            <div class="privacy-options">
                <button class="privacy-option share" 
                        (click)="selectShareOption()" 
                        [disabled]="isShareDisabledForSelectedQuiz">
                    <img src="assets/globe-icon.png" 
                            alt="Share" 
                            class="option-icon">
                    <div class="option-content">
                        <span>Share</span>
                        @if (canShareSelectedQuiz) {
                            <span class="option-description">
                                Anyone can view and study this set
                            </span>
                        }
                        @if (!canShareSelectedQuiz) {
                            <span class="option-description warning">
                                Minimum 3 questions required to share
                            </span>
                        }
                    </div>
                </button>
                <button class="privacy-option private" 
                        (click)="selectPrivateOption()" 
                        [disabled]="isPrivateDisabledForSelectedQuiz">
                    <img src="assets/lock.png" 
                            alt="Private" 
                            class="option-icon">
                    <div class="option-content">
                        <span>Private</span>
                        <span class="option-description">
                            Only you can access this quiz set
                        </span>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <div class="share-overlay" 
        [class.open]="isShareModalOpen" 
        (click)="closeShareModal()">
        <div class="share-modal" (click)="$event.stopPropagation()">
            <h2 class="share-title">Share Quiz Set</h2>
            
            <div class="share-form">
                <div class="form-group">
                    <label class="form-label">Caption</label>
                    <input type="text" 
                        class="form-input" 
                        placeholder="Please enter the caption"
                        [(ngModel)]="shareTitle"/>
                        @if (shareTitle && shareTitle.length > 50) {
                            <div class="validator-message">
                                Caption must not exceed 50 characters
                            </div>
                        }
                </div>

                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" [(ngModel)]="shareCategory">
                        <option value="" disabled selected>
                            Select category
                        </option>
                        <option value="Study Tips">
                            Study Tips
                        </option>
                        <option value="Product Updates">
                            Product Updates
                        </option>
                        <option value="Learning Strategies">
                            Learning Strategies
                        </option>
                        <option value="User Stories">
                            User Stories
                        </option>
                        <option value="Tutorials">
                            Tutorials
                        </option>
                        <option value="Announcements">
                            Announcements
                        </option>
                        <option value="Educational Resources">
                            Educational Resources
                        </option>
                    </select>
                </div>
            </div>

            <div class="share-actions">
                <button class="btn-share-save" (click)="saveShare()"
                    [disabled]="!shareTitle ||
                            !shareCategory || 
                            shareTitle.length > 50">
                    Share
                </button>
                <button class="btn-share-cancel" 
                        (click)="closeShareModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
   <div class="modal-overlay" [class.open]="isAiSuggestionsModalOpen">
        <div class="modal-content ai-suggestions-modal" 
                (click)="$event.stopPropagation()">
            <div class="suggestions-header">
                <h3>Generated Questions</h3>
                <button class="btn-close-suggestion" 
                        (click)="closeSuggestions()">
                    ×
                </button>
            </div>

            <div class="suggestions-body">
                @if (isLoadingSuggestion) {
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Generating AI suggestions...</p>
                    </div>
                }

                @if (!isLoadingSuggestion && suggestedQuestions.length > 0) {
                    <div class="suggestions-list">
                        @for (question of suggestedQuestions; track $index) {
                            <div class="suggestion-item">
                                <span class="suggestion-number">
                                    {{ $index + 1 }}
                                </span>
                                <span class="suggestion-text">
                                    {{ question }}
                                </span>
                            </div>
                        }
                    </div>
                }

                @if (!isLoadingSuggestion && suggestedQuestions.length === 0) {
                    <div class="empty-suggestions">
                        <p>No suggestions generated. Please try again.</p>
                    </div>
                }
            </div>
        </div>
    </div>
    
    @if (isQuizSetCreateSuccessPopupOpen) {
        <div class="popup-alert" (click)="closeQuizSetCreateSuccessPopup()">
            <p>Quiz set created!</p>
        </div>
    }

    @if (isQuizSetDeleteSuccessPopupOpen) {
        <div class="popup-alert" (click)="closeQuizSetDeleteSuccessPopup()">
            <p>Quiz set deleted!</p>
        </div>
    }

    @if (isPrivateSuccessPopupOpen) {
        <div class="popup-alert">
            <p>Quiz set is now private!</p>
        </div>
    }

    @if (isQuizItemSaveSuccessPopupOpen) {
        <div class="popup-alert">
            <p>Quiz item(s) saved!</p>
        </div>
    }

    @if (isQuizShareSuccessPopupOpen) {
        <div class="popup-alert">
            <p>Quiz set shared to community!</p>
        </div>
    }

    @if (isWarningPopupOpen) {
        <div class="popup-alert warning">
            <h2>Warning!</h2>
            <p>{{ warningMessage }}</p>
        </div>
    }
</div>