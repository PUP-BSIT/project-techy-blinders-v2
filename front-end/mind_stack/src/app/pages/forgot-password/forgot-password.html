<div class="forgot-password-class">
    <div class="forgot-password-label">
        <h1>Forgot Password</h1>
    </div>

    @if (isLoading()) {
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Sending...</p>
        </div>
    }

    <form [formGroup]="forgotPasswordForm">
        @if (currentStep() === 1) {
            <div class="form-group">
                <div class="email-class">
                    <div class="email-label">
                        <label>Email</label>
                    </div>
                    <input type="text" formControlName="email" placeholder="Enter your email">
                    <div class="error-container">
                        @if (emailControl?.touched && emailControl?.errors?.['required']) {
                            <span>Email is required</span>
                        } @else if (emailControl?.touched && emailControl?.errors?.['email']) {
                            <span>Invalid email format</span>
                        }
                    </div>
                </div>

                <div class="new-pass-class">
                    <div class="new-pass-label">
                        <label>New Password</label>
                    </div>
                    <div class="password-input-container">
                        <input [type]="showNewPassword ? 'text' : 'password'" formControlName="newPassword" placeholder="Enter your new password">
                        <button type="button" class="show-password-btn" (click)="toggleNewPasswordVisibility()">
                            <img [src]="showNewPassword ? 'assets/unshow-password-icon.png' : 'assets/show-password-icon.png'"
                                  [alt]="showNewPassword ? 'Hide password' : 'Show password'">
                        </button>
                    </div>
                    <div class="error-container">
                        @if(newPasswordControl?.touched) {
                            @if(newPasswordControl?.errors?.['required']){
                                <span>New password is required</span>
                            } @else if(newPasswordControl?.errors?.['minlength']) {
                                <span>Password must be at least 8 characters</span>
                            } @else if(newPasswordControl?.errors?.['uppercase']) {
                                <span>Password must contain at least one uppercase letter</span>
                            } @else if(newPasswordControl?.errors?.['lowercase']) {
                                <span>Password must contain at least one lowercase letter</span>
                            } @else if(newPasswordControl?.errors?.['number']) {
                                <span>Password must contain at least one number</span>
                            } @else if(newPasswordControl?.errors?.['special']) {
                                <span>Password must contain at least one special character (e.g. !@#$%^&*)</span>
                            }
                        }
                    </div>
                </div>

                <div class="confirm-pass-class">
                    <div class="confirm-pass-label">
                        <label>Confirm Password</label>
                    </div>
                    <div class="password-input-container">
                        <input [type]="showConfirmPassword ? 'text' : 'password'" formControlName="confirmPassword" placeholder="Confirm your new password">
                        <button type="button" class="show-password-btn" (click)="toggleConfirmPasswordVisibility()">
                            <img [src]="showConfirmPassword ? 'assets/unshow-password-icon.png' : 'assets/show-password-icon.png'"
                                  [alt]="showConfirmPassword ? 'Hide password' : 'Show password'">
                        </button>
                    </div>
                    <div class="error-container">
                            @if ((confirmPasswordControl?.touched || confirmPasswordControl?.dirty) && confirmPasswordControl?.errors?.['required']) {
                                <span>Confirm password is required</span>
                            } @else if ((confirmPasswordControl?.touched || confirmPasswordControl?.dirty) && confirmPasswordControl?.errors?.['mustMatch']) {
                                <span>Passwords must match</span>
                            } @else if ((confirmPasswordControl?.touched || confirmPasswordControl?.dirty) && errorMessage()) {
                                <span class="error-message">{{ errorMessage() }}</span>
                            }
                    </div>
                </div>
            </div>

            <div class="button-class">
                <button 
                    type="button" 
                    (click)="cancel()" 
                    [disabled]="isLoading()" 
                    id="cancel_button">
                    Cancel
                </button>
                <button 
                    id="next_button"
                    type="button" 
                    (click)="next()" 
                    [disabled]="isLoading() || 
                                !forgotPasswordForm.get('email')?.value || 
                                !forgotPasswordForm.get('newPassword')?.value || 
                                !forgotPasswordForm.get('confirmPassword')?.value || 
                                forgotPasswordForm.get('email')?.invalid || 
                                forgotPasswordForm.get('newPassword')?.invalid || 
                                forgotPasswordForm.get('confirmPassword')?.invalid">
                    Next
                </button>
            </div>
        } @else if (currentStep() === 2) {
            <div class="form-group">
                <div class="otp-class">
                    <button type="button" (click)="sendOtp()" [disabled]="isLoading()" class="btn-secondary">{{ otpSent() ? 'Resend OTP' : 'Send OTP' }}</button>

                    <input
                      type="number"
                      formControlName="otp"
                      placeholder="Enter your OTP"
                      inputmode="numeric"
                      maxlength="6"
                      pattern="\d{6}"
                      class="otp-input"
                      aria-label="OTP"
                      [attr.autofocus]="currentStep() === 2 ? true : null">
                      
                    <small class="helper-text">Enter the 6-digit code we sent to your email.</small>

                    @if (otpControl?.touched) {
                        @if (otpControl?.errors?.['required']) {
                            <div>
                                <span class="otp_error_message">OTP is required</span>
                            </div>
                        }
                        @if (otpControl?.errors?.['pattern']) {
                            <div>
                                <span class="otp_error_message">OTP must be 6 digits</span>
                            </div>
                        }
                    }
                </div>
            </div>

            <div class="button-class">
                <button
                    type="button"
                    class="btn-primary"
                    (click)="resetPassword()"
                    [disabled]="forgotPasswordForm.invalid || isLoading() || !otpControl?.value">
                    Reset Password
                </button>
            </div>
        }
    </form>

    @if (showSuccessPopup()) {
        <div class="popup-overlay" (click)="closeSuccessPopup()">
            <div class="popup" (click)="$event.stopPropagation()">
                <h2>Success!</h2>
                <p>{{ successMessage() || 'Password reset successful!' }}</p>
                <button (click)="closeSuccessPopup()">Close</button>
            </div>
        </div>
    }

    @if (showErrorPopup()) {
        <div class="popup-overlay" (click)="closeErrorPopup()">
            <div class="popup-error" (click)="$event.stopPropagation()">
                <h2>Error</h2>
                <p
                    [class.error-otp-message]="errorPopupMessage === 'Invalid or wrong OTP. Please try again.'"
                    [class.error-generic-message]="errorPopupMessage === 'An error occurred. Please try again.'">
                    {{ errorPopupMessage || 'Invalid or wrong OTP. Please try again.' }}
                </p>
                <button (click)="closeErrorPopup()">Close</button>
            </div>
        </div>
    }
</div>